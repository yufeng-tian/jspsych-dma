<!DOCTYPE html>
<html>
  <head>
    <title>VH Social Perception Study</title>
    
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/@jspsych-builder/datapipe@0.1.0"></script>

    <style>
      /* Dark Background for Eye Comfort and Stimulus Salience */
      body { background-color: #1a1a1a; color: #ffffff; font-family: 'Arial', sans-serif; }
      
      /* High-Impact Feedback Styles */
      .feedback-number { font-size: 80px; font-weight: bold; color: #00ffcc; line-height: 1; }
      .feedback-label { font-size: 24px; color: #cccccc; margin-top: 10px; }
      
      /* Stimulus Styling */
      .stimulus-image { max-height: 500px; max-width: 500px; border: 2px solid #333; border-radius: 8px; }
      
      /* Instruction Styling */
      .instruction-box { text-align: left; max-width: 700px; margin: auto; line-height: 1.6; }
    </style>
  </head>
  <body></body>
  <script>
    
    /* =========================================================
       BLOCK 1: INITIALIZATION
       ========================================================= */
    const jsPsych = initJsPsych({
        on_finish: function() {
            const experiment_id = "YOUR_DATAPIPE_ID_HERE";
            const filename = `subject_${subject_id}_data.csv`;
            const data_to_save = jsPsych.data.get().csv();
            jsPsychPipe.saveData(experiment_id, filename, data_to_save);
        }
    });

    const subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID') || Math.floor(Math.random() * 10000).toString();
    const study_condition = jsPsych.data.getURLVariable('condition') || 'Human';
    const list_num = (parseInt(subject_id.replace(/\D/g, '')) || 1) % 24 + 1;
    const list_path = `lists/list_${String(list_num).padStart(2, '0')}.csv`;

    jsPsych.data.addProperties({
        subject_id: subject_id,
        condition: study_condition,
        list_used: list_path
    });

    /* =========================================================
       BLOCK 2: FEEDBACK LOGIC (High-Impact Display)
       ========================================================= */
    function calculateFeedback(is_target, response_key, intensity) {
        const clean_intensity = String(intensity).trim().toLowerCase();
        
        let is_correct = false;
        // Correct if: (Target AND 't') OR (Non-Target AND Spacebar)
        if ((is_target == 1 && response_key === 't') || (is_target == 0 && response_key === ' ')) {
            is_correct = true;
        }

        let min, max;
        if (is_correct) {
            if (clean_intensity === 'clear') { min = 90; max = 98; }
            else if (clean_intensity === 'subtle') { min = 70; max = 80; }
            else { min = 55; max = 65; } 
        } else { 
            if (clean_intensity === 'clear') { min = 2; max = 10; }
            else if (clean_intensity === 'subtle') { min = 20; max = 30; }
            else { min = 35; max = 45; } 
        }

        const percent = Math.floor(Math.random() * (max - min + 1)) + min;
        
        // Returning HTML with Large Number
        return `
            <div class="feedback-number">${percent}%</div>
            <div class="feedback-label">of others agree with you</div>
        `;
    }

    /* =========================================================
       BLOCK 3: TIMELINE BUILDER
       ========================================================= */
    Papa.parse(list_path, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            buildExperiment(results.data);
        }
    });

    function buildExperiment(csv_data) {
        let timeline = [];

        // Fullscreen Mode
        timeline.push({
            type: jsPsychFullscreen,
            fullscreen_mode: true,
            message: "<h2>Welcome</h2><p>Click below to enter fullscreen and begin the study.</p>",
            button_label: "Enter Fullscreen"
        });

        // Preload Stimuli
        const image_array = csv_data.map(row => row.stimulus).filter(s => s);
        timeline.push({
            type: jsPsychPreload,
            images: image_array,
            message: "Loading study materials..."
        });

        let current_task = "";
        let current_module = "";

        csv_data.forEach((row) => {
            if (!row.stimulus) return;

            // Module Break Message
            if (row.module_id !== current_module) {
                if (current_module !== "") {
                    timeline.push({
                        type: jsPsychHtmlKeyboardResponse,
                        stimulus: `<h2>${current_module} complete.</h2><p>Take a 2-3 minute break. Press ENTER to return.</p>`,
                        choices: ['Enter']
                    });
                }
                current_module = row.module_id;
            }

            // Task Instructions with Forced Reading (10s) and Typing Check
            if (row.task_id !== current_task) {
                current_task = row.task_id;

                // Instruction Screen
                timeline.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `
                        <div class="instruction-box">
                            <h2>Starting ${current_task}</h2>
                            <p><strong>Target:</strong> Faces that feel ${current_task === 'T1' ? 'good/friendly' : 'bad/threatened'}.</p>
                            <p><strong>Keys:</strong> Press <strong>T</strong> for Target | Press <strong>SPACE</strong> to Pass.</p>
                            <p><em>Please read carefully. The continue button will enable in 10 seconds.</em></p>
                        </div>`,
                    choices: ['Continue'],
                    enable_button_after: 10000
                });

                // Comprehension Typing Check
                timeline.push({
                    type: jsPsychSurveyText,
                    questions: [{prompt: "Type the target feeling for this section:", required: true}]
                });
            }

            // Fixation
            timeline.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<div style="font-size: 60px;">+</div>',
                choices: "NO_KEYS",
                trial_duration: 500
            });

            // Face Trial (500ms Stimulus Duration)
            timeline.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<img src="${row.stimulus}" class="stimulus-image">`,
                choices: ['t', ' '],
                stimulus_duration: 500,
                data: { ...row },
                on_finish: function(data) {
                    data.feedback_html = calculateFeedback(data.is_target, data.response, data.intensity);
                }
            });

            // Feedback Trial (Large Display)
            timeline.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() { return jsPsych.data.get().last(1).values()[0].feedback_html; },
                choices: "NO_KEYS",
                trial_duration: 1500
            });
        });

        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<h2>Thank you!</h2><p>Saving data...</p>",
            choices: "NO_KEYS",
            trial_duration: 3000
        });

        jsPsych.run(timeline);
    }
  </script>
</html>