<!DOCTYPE html>
<html>
  <head>
    <title>VH Social Perception Study</title>
    
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen"></script>
    
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <script src="https://unpkg.com/@jspsych-builder/datapipe@0.1.0"></script>

    <style>
      .feedback-text { font-size: 32px; font-weight: bold; margin-top: 20px; }
      .stimulus-image { max-height: 500px; max-width: 500px; border-radius: 10px; }
    </style>
  </head>
  <body></body>
  <script>
    
    /* =========================================================
       BLOCK 1: INITIALIZATION & VARIABLES
       ========================================================= */
    const jsPsych = initJsPsych({
        on_finish: function() {
            // Save data to OSF via DataPipe when finished
            const experiment_id = "YOUR_DATAPIPE_ID_HERE"; // Update this later
            const filename = `subject_${subject_id}_${study_condition}_data.csv`;
            const data_to_save = jsPsych.data.get().csv();
            
            jsPsychPipe.saveData(experiment_id, filename, data_to_save);
        }
    });

    // Capture URL Variables from Qualtrics
    const subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID') || Math.floor(Math.random() * 10000).toString();
    const study_condition = jsPsych.data.getURLVariable('condition') || 'Human'; // 'Human' or 'AI'
    
    // Counterbalance Response Keys (Even ID = F, Odd ID = J)
    const is_even = (parseInt(subject_id.replace(/\D/g, '')) || 0) % 2 === 0;
    const key_target = is_even ? 'f' : 'j';
    const key_nontarget = is_even ? 'j' : 'f';

    // Select 1 of 24 lists based on Subject ID
    const list_num = (parseInt(subject_id.replace(/\D/g, '')) || 1) % 24 + 1;
    const list_path = `lists/list_${String(list_num).padStart(2, '0')}.csv`;

    // Save overarching variables to every row of data
    jsPsych.data.addProperties({
        subject_id: subject_id,
        condition: study_condition,
        list_used: list_path,
        key_target: key_target
    });

    /* =========================================================
       BLOCK 2: FEEDBACK LOGIC
       ========================================================= */
    function calculateFeedback(is_target, response_key, intensity) {
        let is_correct = false;
        if ((is_target == 1 && response_key === key_target) || 
            (is_target == 0 && response_key === key_nontarget)) {
            is_correct = true;
        }

        let min, max;
        if (is_correct) {
            if (intensity === 'clear') { min = 90; max = 98; }
            else if (intensity === 'subtle') { min = 70; max = 80; }
            else { min = 55; max = 65; } // Neutral
        } else { 
            if (intensity === 'clear') { min = 2; max = 10; }
            else if (intensity === 'subtle') { min = 20; max = 30; }
            else { min = 35; max = 45; } // Neutral
        }

        const percent = Math.floor(Math.random() * (max - min + 1)) + min;
        return `<div class='feedback-text'>${percent}% of others agree with you.</div>`;
    }

    /* =========================================================
       BLOCK 3: CSV PARSER & TIMELINE BUILDER
       ========================================================= */
    // Download and read the CSV file
    Papa.parse(list_path, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
            buildAndRunExperiment(results.data);
        }
    });

    function buildAndRunExperiment(csv_data) {
        let timeline = [];

        // 1. Fullscreen
        timeline.push({
            type: jsPsychFullscreen,
            fullscreen_mode: true,
            message: `<p>Welcome to the Vibe Hang Social Perception Study.</p>
                      <p>Target Key: <strong>${key_target.toUpperCase()}</strong></p>
                      <p>Non-Target Key: <strong>${key_nontarget.toUpperCase()}</strong></p>
                      <p>Press the button below to enter fullscreen and begin.</p>`
        });

        // 2. Preload all images from the CSV
        const image_array = csv_data.map(row => row.stimulus);
        timeline.push({
            type: jsPsychPreload,
            images: image_array,
            show_progress_bar: true,
            message: "Loading visual assets, please wait..."
        });

        // 3. Loop through the 540 rows to build trials
        let current_task = "";

        csv_data.forEach((row) => {
            
            // A. Detect if we started a new Task/Block and insert Instructions
            if (row.task_id !== current_task) {
                current_task = row.task_id;
                
                // We skip Module 2 (Task 3 & 4) if they are in the AI condition
                if (study_condition === 'AI' && (current_task === 'T3' || current_task === 'T4')) {
                    return; // Skip adding these trials to timeline
                }

                timeline.push({
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<h2>Starting ${current_task}</h2>
                               <p>Target key: <strong>${key_target.toUpperCase()}</strong> | Non-target key: <strong>${key_nontarget.toUpperCase()}</strong></p>
                               <p><em>(You can paste your detailed instructions here later)</em></p>
                               <p>Press SPACE to begin.</p>`,
                    choices: [' ']
                });
            }

            // B. Fixation Cross
            const fixation = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<div style="font-size: 60px;">+</div>',
                choices: "NO_KEYS",
                trial_duration: 500
            };

            // C. The Face Stimulus Trial
            const face_trial = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `<img src="${row.stimulus}" class="stimulus-image">`,
                choices: ['f', 'j'],
                data: {
                    task_id: row.task_id,
                    module_id: row.module_id,
                    is_target: row.is_target,
                    target_type: row.target_type,
                    intensity: row.intensity,
                    expression: row.expression,
                    actor_category: row.actor_category
                },
                on_finish: function(data) {
                    // Calculate feedback instantly when they press F or J
                    data.feedback_display = calculateFeedback(data.is_target, data.response, data.intensity);
                    data.correct = ((data.is_target == 1 && data.response === key_target) || (data.is_target == 0 && data.response === key_nontarget));
                }
            };

            // D. The Social Feedback Trial
            const feedback_trial = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() {
                    // Pull the feedback generated in the previous step
                    return jsPsych.data.get().last(1).values()[0].feedback_display;
                },
                choices: "NO_KEYS",
                trial_duration: 1500
            };

            // Push the sequence: Fixation -> Face -> Feedback
            timeline.push(fixation, face_trial, feedback_trial);
        });

        // 4. End Screen
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<h2>Experiment Complete!</h2><p>Please wait a moment while your data is securely saved.</p>",
            choices: "NO_KEYS",
            trial_duration: 3000
        });

        // 5. Start the Experiment
        jsPsych.run(timeline);
    }
  </script>
</html>